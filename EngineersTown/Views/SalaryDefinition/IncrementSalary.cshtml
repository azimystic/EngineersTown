@model EngineersTown.Models.ViewModels.BPSIncrementViewModel

@{
    ViewData["Title"] = "Increment Basic Salary by BPS";
}

<div class="max-w-5xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-6 py-4 rounded-t-lg">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-semibold flex items-center">
                    <i class="fas fa-chart-line mr-3"></i>
                    Increment Basic Salary by BPS
                </h1>
                <a asp-action="Index" class="px-4 py-2 bg-white text-emerald-600 font-medium rounded-md hover:bg-gray-50 focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-emerald-600 transition-colors duration-200 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Back to List
                </a>
            </div>
        </div>

        <div class="p-6">
            <!-- Info Alert -->
            <div class="mb-6 px-4 py-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 flex items-start">
                <i class="fas fa-info-circle mr-3 mt-0.5"></i>
                <div>
                    <p class="font-medium">How it works:</p>
                    <ul class="list-disc list-inside mt-1 text-sm">
                        <li>Each BPS level has a predefined increment amount</li>
                        <li>Click the edit icon to modify the increment amount for any BPS</li>
                        <li>Click "Increment" to apply the increment to all employees in that BPS</li>
                        <li>Use "Increment All" to apply increments to all BPS levels at once</li>
                    </ul>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="alertContainer" class="mb-4 hidden">
                <div id="alertMessage" class="px-4 py-3 rounded-md flex items-center"></div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BPS Level</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Employees</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Increment Amount</th>
                                @* <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th> *@
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @foreach (var item in Model.BPSItems)
                            {
                                <tr class="hover:bg-gray-50 transition-colors duration-150" data-bps="@item.BPS">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-800">
                                            <i class="fas fa-layer-group mr-2"></i>
                                            BPS-@item.BPS
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="inline-flex items-center px-2. 5 py-0.5 rounded-full text-xs font-medium @(item.EmployeeCount > 0 ? "bg-blue-100 text-blue-800" : "bg-gray-100 text-gray-500")">
                                            <i class="fas fa-users mr-1"></i>
                                            @item.EmployeeCount employee(s)
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <div class="flex items-center justify-center space-x-2">
                                            <div class="relative">
                                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">Rs. </span>
                                                <input type="number"
                                                       id="increment-@item.BPS"
                                                       value="@item.IncrementAmount"
                                                       step="0.01"
                                                       disabled
                                                       class="increment-input pl-10 pr-4 py-2 w-32 text-right border border-gray-300 rounded-md bg-gray-100 text-gray-700 font-semibold focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 disabled:bg-gray-100 disabled:cursor-not-allowed" />
                                            </div>
                                            <button type="button"
                                                    onclick="toggleEdit(@item.BPS)"
                                                    class="edit-btn p-2 text-indigo-600 hover:text-indigo-900 hover:bg-indigo-50 rounded-md transition-colors duration-150"
                                                    title="Edit increment amount">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button"
                                                    onclick="saveEdit(@item.BPS)"
                                                    class="save-btn hidden p-2 text-green-600 hover:text-green-900 hover:bg-green-50 rounded-md transition-colors duration-150"
                                                    title="Save changes">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button"
                                                    onclick="cancelEdit(@item.BPS, @item.IncrementAmount)"
                                                    class="cancel-btn hidden p-2 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-md transition-colors duration-150"
                                                    title="Cancel">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                    @* <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <button type="button"
                                                onclick="incrementBPS(@item.BPS)"
                                                class="increment-single-btn px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-md hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed @(item.EmployeeCount == 0 ? "opacity-50 cursor-not-allowed" : "")"
                                                @(item.EmployeeCount == 0 ? "disabled" : "")>
                                            <i class="fas fa-plus-circle mr-1"></i> Increment
                                        </button>
                                    </td> *@
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Increment All Button -->
            <div class="mt-6 flex justify-end">
                <button type="button"
                        onclick="incrementAllBPS()"
                        id="incrementAllBtn"
                        class="px-6 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 text-gray font-semibold rounded-md hover:from-emerald-700 hover:to-emerald-800 focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-all duration-200 flex items-center shadow-lg">
                    <i class="fas fa-layer-group mr-2"></i>
                    Increment All BPS Levels
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100">
                <i class="fas fa-exclamation-triangle text-emerald-600 text-xl"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" id="modalTitle">Confirm Increment</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="modalMessage">Are you sure you want to proceed? </p>
            </div>
            <div class="flex justify-center space-x-4 px-4 py-3">
                <button id="modalCancel" class="px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-md hover:bg-gray-400 focus:ring-2 focus:ring-gray-300 transition-colors duration-200">
                    Cancel
                </button>
                <button id="modalConfirm" class="px-4 py-2 bg-emerald-600 text-gray font-medium rounded-md hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-500 transition-colors duration-200">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let confirmCallback = null;

        function showAlert(message, isSuccess) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.getElementById('alertMessage');

            container. classList.remove('hidden');
            alertDiv.className = `px-4 py-3 rounded-md flex items-center ${isSuccess ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800'}`;
            alertDiv.innerHTML = `<i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>${message}`;

            setTimeout(() => {
                container. classList.add('hidden');
            }, 5000);
        }

        function toggleEdit(bps) {
            const input = document.getElementById(`increment-${bps}`);
            const row = document.querySelector(`tr[data-bps="${bps}"]`);
            const editBtn = row.querySelector('.edit-btn');
            const saveBtn = row. querySelector('.save-btn');
            const cancelBtn = row.querySelector('.cancel-btn');

            input.disabled = false;
            input.classList.remove('bg-gray-100');
            input.classList.add('bg-white');
            input.focus();

            editBtn.classList. add('hidden');
            saveBtn.classList. remove('hidden');
            cancelBtn.classList.remove('hidden');
        }

        function saveEdit(bps) {
            const input = document. getElementById(`increment-${bps}`);
            const row = document.querySelector(`tr[data-bps="${bps}"]`);
            const editBtn = row.querySelector('.edit-btn');
            const saveBtn = row.querySelector('. save-btn');
            const cancelBtn = row.querySelector('.cancel-btn');

            input.disabled = true;
            input. classList.add('bg-gray-100');
            input.classList.remove('bg-white');

            editBtn.classList.remove('hidden');
            saveBtn. classList.add('hidden');
            cancelBtn.classList.add('hidden');
        }

        function cancelEdit(bps, originalValue) {
            const input = document.getElementById(`increment-${bps}`);
            input.value = originalValue;
            saveEdit(bps);
        }

        function showConfirmModal(title, message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').textContent = title;
            document. getElementById('modalMessage'). textContent = message;
            confirmCallback = callback;
            modal.classList.remove('hidden');
        }

        document.getElementById('modalCancel').addEventListener('click', function() {
            document. getElementById('confirmModal'). classList.add('hidden');
            confirmCallback = null;
        });

        document.getElementById('modalConfirm').addEventListener('click', function() {
            document.getElementById('confirmModal').classList.add('hidden');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        });

        function incrementBPS(bps) {
            const incrementAmount = parseFloat(document.getElementById(`increment-${bps}`).value);

            showConfirmModal(
                'Confirm Increment',
                `Are you sure you want to increment basic salary by Rs. ${incrementAmount. toFixed(2)} for all employees in BPS-${bps}? `,
                function() {
                    const formData = new FormData();
                    formData.append('bps', bps);
                    formData.append('incrementAmount', incrementAmount);

                    fetch('@Url.Action("IncrementSalaryByBPS")', {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: formData
                    })
                    .then(response => response. json())
                    .then(data => {
                        showAlert(data.message, data.success);
                        if (data.success) {
                            // Update employee count display if needed
                        }
                    })
                    .catch(error => {
                        showAlert('An error occurred. Please try again.', false);
                    });
                }
            );
        }

        function incrementAllBPS() {
            const bpsItems = [];
            document.querySelectorAll('tr[data-bps]').forEach(row => {
                const bps = parseInt(row.dataset. bps);
                const incrementAmount = parseFloat(document.getElementById(`increment-${bps}`). value);
                bpsItems.push({ bps: bps, incrementAmount: incrementAmount });
            });

            showConfirmModal(
                'Confirm Increment All',
                'Are you sure you want to increment basic salary for ALL employees across all BPS levels?  This action cannot be undone.',
                function() {
                    fetch('@Url.Action("IncrementAllBPS")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?. value || ''
                        },
                        body: JSON.stringify(bpsItems)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '@Url.Action("Index")';
                        } else {
                            showAlert(data.message, false);
                        }
                    })
                    .catch(error => {
                        showAlert('An error occurred. Please try again.', false);
                    });
                }
            );
        }
    </script>
    @Html.AntiForgeryToken()
}